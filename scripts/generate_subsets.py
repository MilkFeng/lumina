import json
import os
import subprocess
import urllib.request
import ssl

# ================= é…ç½®åŒºåŸŸ =================

# ARB æ–‡ä»¶è·¯å¾„ (UI æ–‡æ¡ˆ)
ARB_FILE = '../lib/l10n/app_zh.arb'

# å­—ä½“æ–‡ä»¶å¤¹è·¯å¾„
FONT_DIR = '../assets/fonts/'

# å­—ä½“ä¸‹è½½åœ°å€
FONT_DOWNLOAD_BASE_URL = 'https://github.com/adobe-fonts/source-han-serif/releases/latest/download/09_SourceHanSerifSC.zip'
FONTS_CONFIG = {}

CHAR_SOURCES = [
    {
        "name": "xiandai_changyong.txt", # ç°ä»£æ±‰è¯­å¸¸ç”¨å­—è¡¨ (è€3500)
        "url": "https://raw.githubusercontent.com/NightFurySL2001/cjktables/master/china/standard/xiandai_changyong.txt"
    },
    {
        "name": "yiwu_jiaoyu.txt", # ä¹‰åŠ¡æ•™è‚²è¯­æ–‡è¯¾ç¨‹å¸¸ç”¨å­—è¡¨ (æ–°3500)
        "url": "https://raw.githubusercontent.com/NightFurySL2001/cjktables/master/china/standard/yiwu_jiaoyu.txt"
    },
    {
        "name": "gb_t_2312.txt", # GB/T 2312-80 (6763å­—)
        "url": "https://raw.githubusercontent.com/NightFurySL2001/cjktables/master/china/encoding/gb_t_2312.txt"
    },
    {
        "name": "tongyong_guifan.txt", # é€šç”¨è§„èŒƒæ±‰å­—è¡¨ (8105å­—)
        "url": "https://raw.githubusercontent.com/NightFurySL2001/cjktables/master/china/standard/tongyong_guifan.txt"
    },
    {
        "name": "biaozhun_dianma.txt", # ã€Šæ ‡å‡†ç”µç æœ¬ï¼ˆä¿®è®¢æœ¬ï¼‰ã€‹(1983å¹´)å«ç¼–å·
        "url": "https://raw.githubusercontent.com/zispace/hanzi-chars-ext/master/%E8%A7%84%E8%8C%83%E5%AD%97%E8%A1%A8%E8%A1%A5%E5%85%85/%E3%80%8A%E6%A0%87%E5%87%86%E7%94%B5%E7%A0%81%E6%9C%AC%EF%BC%88%E4%BF%AE%E8%AE%A2%E6%9C%AC%EF%BC%89%E3%80%8B%EF%BC%881983%E5%B9%B4%EF%BC%89%E5%90%AB%E7%BC%96%E5%8F%B7.txt"
    },
    {
        "name": "gbk.txt", # GBK-1995 å­—ç¬¦é›†
        "url": "https://raw.githubusercontent.com/zispace/hanzi-chars/master/data-charset/GBK-1995.txt"
    }
]

# ä½ çš„å­—ä½“å®¶æ—åç§°
FONT_FAMILY_NAME = "AppSerif"
FONT_FAMILY_CONTENT_NAME = "AppSerifContent"

# ===========================================

def get_combined_chars():
    """ä¸‹è½½å¹¶åˆå¹¶æ‰€æœ‰æŒ‡å®šçš„æ±‰å­—å­—ç¬¦é›†"""
    combined_chars = set()
    
    # å¿½ç•¥ SSL è¯ä¹¦éªŒè¯ (é˜²æ­¢æŸäº›ç½‘ç»œç¯å¢ƒä¸‹æŠ¥é”™)
    ssl_context = ssl._create_unverified_context()

    print(f"ğŸŒ å‡†å¤‡è·å–æ‰©å±•å­—ç¬¦é›† (å…± {len(CHAR_SOURCES)} ä¸ªæ¥æº)...")

    for source in CHAR_SOURCES:
        filename = source["name"]
        url = source["url"]
        
        # 1. å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œå…ˆä¸‹è½½
        if not os.path.exists(filename):
            print(f"   â¬‡ï¸ æ­£åœ¨ä¸‹è½½: {filename} ...")
            try:
                # ä½¿ç”¨ urllib ä¸‹è½½ï¼Œä¼ å…¥ ssl context
                with urllib.request.urlopen(url, context=ssl_context) as response, open(filename, 'wb') as out_file:
                    out_file.write(response.read())
                print(f"      âœ… ä¸‹è½½æˆåŠŸ")
            except Exception as e:
                print(f"      âŒ ä¸‹è½½å¤±è´¥ [{filename}]: {e}")
                continue
        else:
            print(f"   ğŸ“‚ è¯»å–æœ¬åœ°æ–‡ä»¶: {filename}")

        # 2. è¯»å–å¹¶è§£æå­—ç¬¦
        try:
            with open(filename, 'r', encoding='utf-8') as f:
                content = f.read()
                # ç®€å•è§£æï¼šè¿‡æ»¤æ‰ # å¼€å¤´çš„æ³¨é‡Šè¡Œï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç„¶åæå–æ‰€æœ‰éç©ºç™½å­—ç¬¦
                count = 0
                for line in content.splitlines():
                    if line.strip().startswith('#'): continue
                    for char in line:
                        if char.strip(): # åªè¦ä¸æ˜¯ç©ºæ ¼/æ¢è¡Œ
                            combined_chars.add(char)
                            count += 1
                # print(f"      + æ·»åŠ äº† {count} ä¸ªå­—ç¬¦")
        except Exception as e:
            print(f"      âŒ è¯»å–å¤±è´¥: {e}")

    print(f"ğŸ“Š å­—ç¬¦é›†å¤„ç†å®Œæ¯•ï¼Œå»é‡åå…±è®¡: {len(combined_chars)} ä¸ªæ±‰å­—")
    return combined_chars

def download_and_extract_font():
    """ä¸‹è½½å¹¶è§£å‹å­—ä½“æ–‡ä»¶"""
    zip_path = 'source_han_serif.zip'
    
    if not os.path.exists(zip_path):
        print(f"â¬‡ï¸ æ­£åœ¨ä¸‹è½½å­—ä½“æ–‡ä»¶: {FONT_DOWNLOAD_BASE_URL} ...")
        try:
            urllib.request.urlretrieve(FONT_DOWNLOAD_BASE_URL, zip_path)
            print(f"   âœ… å­—ä½“ä¸‹è½½æˆåŠŸ")
        except Exception as e:
            print(f"   âŒ å­—ä½“ä¸‹è½½å¤±è´¥: {e}")
            return False
    else:
        print(f"ğŸ“‚ å­—ä½“å‹ç¼©åŒ…å·²å­˜åœ¨: {zip_path}")

    # è§£å‹åˆ° FONT_DIR
    if not os.path.exists('./fonts'):
        try:
            import zipfile
            with zipfile.ZipFile(zip_path, 'r') as zip_ref:
                zip_ref.extractall('./fonts')
            print(f"   âœ… å­—ä½“è§£å‹æˆåŠŸåˆ°: './fonts'")
        except Exception as e:
            print(f"   âŒ å­—ä½“è§£å‹å¤±è´¥: {e}")
            return False
    
    # æ›´æ–° FONTS_CONFIG
    for file in os.listdir('./fonts/OTF/SimplifiedChinese'):
        if file.endswith('.otf'):
            weight = None
            if 'ExtraLight' in file:
                weight = 200
            elif 'Light' in file:
                weight = 300
            elif 'Regular' in file:
                weight = 400
            elif 'Medium' in file:
                weight = 500
            elif 'SemiBold' in file:
                weight = 600
            elif 'Bold' in file:
                weight = 700
            elif 'Heavy' in file:
                weight = 900

            path = os.path.join('./fonts/OTF/SimplifiedChinese', file)
            
            if weight is not None:
                FONTS_CONFIG[path] = weight

def main():
    final_chars = set()

    # 0. ä¸‹è½½åŸå§‹å­—ä½“æ–‡ä»¶å¹¶è§£å‹
    print("ğŸš€ å¼€å§‹ç”Ÿæˆå­—ä½“å­é›†...")
    download_and_extract_font()

    # 1. æå– ARB å­—ç¬¦ (UI)
    print(f"ğŸ“– æ­£åœ¨è¯»å– ARB æ–‡ä»¶: {ARB_FILE} ...")
    if os.path.exists(ARB_FILE):
        with open(ARB_FILE, 'r', encoding='utf-8') as f:
            data = json.load(f)
        for key, value in data.items():
            if key.startswith('@'): continue
            final_chars.update(list(value))
        print(f"   å·²æå– ARB å­—ç¬¦ï¼Œå½“å‰æ€»æ•°: {len(final_chars)}")
    else:
        print(f"âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° ARB æ–‡ä»¶ {ARB_FILE}ï¼Œå°†è·³è¿‡ UI å­—ç¬¦æå–ã€‚")

    # 2. æ·»åŠ  ASCII (è‹±æ–‡/æ•°å­—/ç¬¦å·)
    ascii_chars = set(chr(i) for i in range(0x0020, 0x007F))
    final_chars.update(ascii_chars)
    
    # 3. æ·»åŠ ç‰¹æ®Šå­—ç¬¦
    special_chars = """
âœâœâœâœ‘âœ’âœâœ‰âœâœ‚âœƒâœ„âœ†âœ‰â˜â˜â˜‘âœ“âœ”âˆšâ˜â˜’âœ—âœ˜ã„¨âœ•âœ–âœ–â˜¢â˜ â˜£âœˆâ˜…â˜†âœ¡å›ã¿â˜¯â˜°â˜²â˜±â˜´â˜µâ˜¶â˜³â˜·â˜œâ˜â˜âœâ˜šâ˜›â˜ŸâœŒâ™¤â™§â™¡â™¢â™ â™£â™¥â™¦â˜€â˜â˜‚â„â˜ƒâ™¨ì›ƒìœ â–â˜½â˜¾â˜ªâœ¿â™‚â™€âœªâœ¯â˜­â³ååâˆšÃ—â– â—†â—â—‹â—â—‘âœ™â˜ºâ˜»â€âš˜â™”â™•â™–â™—â™˜â™™â™šâ™›â™œâ™â™â™Ÿâ™§â™¡â™‚â™€â™ â™£â™¥â¤â˜œâ˜â˜â˜âŠ™â—â˜ºâ˜»â˜¼â–§â–¨â™¨â—â—‘â†”â†•â–ªâ–’â—Šâ—¦â–£â–¤â–¥â–¦â–©â—˜â—ˆâ—‡â™¬â™ªâ™©â™­â™ªã®â˜…â˜†â†’ã‚ãƒï¿¡Ğ®ã€“Â§â™¤â™¥â–¶Â¤âœ²âˆâœ¿âœ²âˆâ¹â˜€â˜‚â˜ã€ã€‘â”±â”²â£âœšâœªâœ£âœ¤âœ¥âœ¦â‰â¥â¦â§âƒâ‚ââ€âœ„â˜ªâ˜£â˜¢â˜ â˜­áƒ¦â–¶â–·â—€â—â˜€â˜â˜‚â˜ƒâ˜„â˜…â˜†â˜‡â˜ˆâŠ™â˜Šâ˜‹â˜Œâ˜â“›â“â“¥â“”â•¬ã€ã€âˆ´â˜€â™«â™¬â™©â™­â™ªâ˜†âˆ·ï¹Œã®â˜…â—â–¶â˜ºâ˜»â–ºâ—„â–§â–¨â™¨â—â—‘â†”â†•â†˜â–€â–„â–ˆâ–Œâ—¦â˜¼â™ªã®â˜†â†’â™§ãƒï¿¡â¤â–’â–¬â™¦â—Šâ—¦â™ â™£â–£Û°â€¢â¤â€¢Û°â–ºâ—„â–§â–¨â™¨â—â—‘â†”â†•â–ªâ–«â˜¼â™¦âŠ™â—â—‹â‘ âŠ•â—Î˜âŠ™Â¤ãŠ£â˜…â˜†â™€â—†â—‡â—£â—¢â—¥â–²â–¼â–³â–½âŠ¿â—¤â—¥âœâœŒâœâœ¡âœ“âœ”âœ•âœ–â™‚â™€â™¥â™¡â˜œâ˜â˜â˜âŠ™â—â˜ºâ˜»â–ºâ—„â–§â–¨â™¨â—â—‘â†”â†•â™¥â™¡â–ªâ–«â˜¼â™¦â–€â–„â–ˆâ–Œâ–â–‘â–’â–¬â™¦â—Šâ—˜â—™â—¦â˜¼â™ â™£â–£â–¤â–¥â–¦â–©â—˜â—™â—ˆâ™«â™¬â™ªâ™©â™­â™ªâœ„â˜ªâ˜£â˜¢â˜ â™¯â™©â™ªâ™«â™¬â™­â™®â˜â˜â˜ªâ™ˆÂºÂºâ‚ªÂ¤íÂ«Â»â„¢â™‚âœ¿â™¥ã€€â—•â€¿-ï½¡ã€€ï½¡â—•â€¿â—•ï½¡
âœ½âœ¾âœ¿ââƒâ‹â€âš˜â˜‘âœ“âœ”âˆšâ˜â˜’âœ—âœ˜âœ•âœ–âœ–â‹†âœ¢âœ£âœ¤âœ¥â‹âœ¦âœ§âœ©âœ°âœªâœ«âœ¬âœ­âœ®âœ¯â‚âœ¡â˜…âœ±âœ²âœ³âœ´âœµâœ¶âœ·âœ¸âœ¹âœºâœ»âœ¼â„â…â†â‡âˆâ‰âŠâ€ â˜¨âœâœâ˜¥â˜¦â˜“â˜©â˜¯â˜§â˜¬â˜¸âœ¡â™âœ™â™†ã€‚ï¼Œã€ï¼‡ï¼šâˆ¶ï¼›?â€˜â€™â€œâ€ã€ã€Ë†Ë‡ï¹•ï¸°ï¹”ï¹–ï¹‘â€¢Â¨â€¦.Â¸;ï¼Â´ï¼Ÿï¼ï½â€”Ë‰ï½œâ€–ï¼‚ã€ƒï½€@ï¹«Â¡Â¿ï¹ï¹‹ï¹Œï¸´ã€…ï¹Ÿ#ï¹©$ï¹ &ï¹ª%*ï¹¡ï¹¢ï¹¦ï¹¤â€ï¿£Â¯â€•ï¹¨Ë†Ëœï¹ï¹+=<ï¼¿_-\Ë‡~ï¹‰ï¹Šï¼ˆï¼‰ã€ˆã€‰â€¹â€ºï¹›ï¹œã€ã€ã€–ã€—ï¼»ï¼½ã€Šã€‹ã€”ã€•{}ã€Œã€ã€ã€‘ï¸µï¸·ï¸¿ï¸¹ï¸½_ï¹ï¹ƒï¸»ï¸¶ï¸¸ï¹€ï¸ºï¸¾Ë‰ï¹‚ï¹„ï¸¼â˜¯â™ â™£â™§â™¡â™¥â¤â¥â£â™‚â™€âœ²â˜€â˜¼â˜¾â˜½â—â—‘â˜ºâ˜»â˜â˜âœ¿â€â„–â†‘â†“â†â†’âˆšÃ—Ã·â˜…â„ƒâ„‰Â°â—†â—‡âŠ™â– â–¡â–³â–½Â¿Â½â˜¯âœ¡ã¿ååâ™‚â™€âœšã€“ã¡â™ªâ™«â™©â™¬ãŠšãŠ›å›ãŠ’ãŠ–Î¦â™€â™‚â€–$@*&#â€»ååÎ¨â™«â™¬â™­â™©â™ªâ™¯â™®âŒ’Â¶âˆ®â€–â‚¬ï¿¡Â¥$â˜©â˜¨â˜¦âœâœ›âœœâœâœ™âœ âœšâ€ â€¡â—‰â—‹â—Œâ—â—â—â—â—‘â—’â—“â—”â—•â—–â——â‚â˜¢âŠ—âŠ™â—˜â—™â—â„‚â„â„•â„™â„šâ„â„¤â„¬â„°â„¯â„±â„Šâ„‹â„â„â„’â„“â„³â„´â„˜â„›â„­â„®â„Œâ„‘â„œâ„¨â™ªâ™«â™©â™¬â™­â™®â™¯Â°Ã¸â’¶â˜®âœŒâ˜ªâœ¡â˜­âœ¯åâœâœâœâœ‘âœ’âœâœ‰âœâœ‚âœƒâœ„âœ†âœ‰
â˜â˜âŸâ¡â¢â£â¤â¥â¦â§â¨âšâ˜â™â›âœâââ¸â™â²â³ââ´âµâ¶â·â¸â¹âºâ»â¼â½â†â†‘â†’â†“â†”â†•â†–â†—â†˜â†™â†šâ†›â†œâ†â†â†Ÿâ† â†¡â†¢â†£â†¤â†¥â†¦â†§â†¨â«â¬â©âªâ­â®â¯â±â†©â†ªâ†«â†¬â†­â†®â†¯â†°â†±â†²â†³â†´â†µâ†¶â†·â†¸â†¹â†ºâ†»â†¼â†½â†¾â†¿â‡€â‡â‡‚â‡ƒâ‡„â‡…â‡†â‡‡â‡ˆâ‡‰â‡Šâ‡‹â‡Œâ‡â‡â‡â‡â‡‘â‡’â‡“â‡”â‡•â‡–â‡—â‡˜â‡™â‡šâ‡›â‡œâ‡â‡â‡Ÿâ‡ â‡¡â‡¢â‡£â‡¤â‡¥â‡¦â‡§â‡¨â‡©â‡ª
â… â…¡â…¢â…£â…¤â…¥â…¦â…§â…¨â…©â…ªâ…«â…¬â…­â…®â…¯â…°â…±â…²â…³â…´â…µâ…¶â…·â…¸â…¹â…ºâ…»â…¼â…½â…¾â…¿â”Œâ”â”â”â”â”‘â”’â”“â””â”•â”–â”—â”˜â”™â”šâ”›â”œâ”â”â”Ÿâ” â”¡â”¢â”£â”¤â”¥â”¦â”§â”¨â”©â”ªâ”«â”¬â”­â”®â”¯â”°â”±â”²â”³â”´â”µâ”¶â”·â”¸â”¹â”ºâ”»â”¼â”½â”¾â”¿â•€â•â•‚â•ƒâ•„â•…â•†â•‡â•ˆâ•‰â•Šâ•‹â•Œâ•â•â•â•â•‘â•’â•“â•”â••â•–â•—â•˜â•™â•šâ•›â•œâ•â•â•Ÿâ• â•¡â•¢â•£â•¤â•¥â•¦â•§â•¨â•©â•ªâ•«â•¬â—¤â—¥â—„â–ºâ–¶â—€â—£â—¢â–²â–¼â—¥â–¸â—‚â–´â–¾â–³â–½â–·â—âŠ¿â–»â—…â–µâ–¿â–¹â—ƒâââ‘â’â–€â–â–‘â–’â–“â–”â–•â– â–¡â–¢â–£â–¤â–¥â–¦â–§â–¨â–©â–ªâ–«â–¬â–­â–®â–¯ã‹€ã‹ã‹‚ã‹ƒã‹„ã‹…ã‹†ã‹‡ã‹ˆã‹‰ã‹Šã‹‹ã ã¡ã¢ã£ã¤ã¥ã¦ã§ã¨ã©ãªã«ã¬ã­ã®ã¯ã°ã±ã²ã³ã´ãµã¶ã·ã¸ã¹ãºã»ã¼ã½ã¾ã™ãšã›ãœãããŸã ã¡ã¢ã£ã¤ã¥ã¦ã§ã¨ã©ãªã«ã¬ã­ã®ã¯ã°ã˜â˜°â˜²â˜±â˜´â˜µâ˜¶â˜³â˜·
â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©â‘ªâ‘«â‘¬â‘­â‘®â‘¯â‘°â‘±â‘²â‘³â“ªâ“¿â¶â·â¸â¹âºâ»â¼â½â¾â¿â“«â“¬â“­â“®â“¯â“°â“±â“²â“³â“´â“µâ“¶â“·â“¸â“¹â“ºâ“»â“¼â“½â“¾ãŠ€ãŠãŠ‚ãŠƒãŠ„ãŠ…ãŠ†ãŠ‡ãŠˆãŠ‰
ãˆ ãˆ¡ãˆ¢ãˆ£ãˆ¤ãˆ¥ãˆ¦ãˆ§ãˆ¨ãˆ©â‘´â‘µâ‘¶â‘·â‘¸â‘¹â‘ºâ‘»â‘¼â‘½â‘¾â‘¿â’€â’â’‚â’ƒâ’„â’…â’†â’‡
â’ˆâ’‰â’Šâ’‹â’Œâ’â’â’â’â’‘â’’â’“â’”â’•â’–â’—â’˜â’™â’šâ’›â… â…¡â…¢â…£â…¤â…¥â…¦â…§â…¨â…©â…ªâ…«â…°â…±â…²â…³â…´â…µâ…¶â…·â…¸â…¹
â’¶â’·â’¸â’¹â’ºâ’»â’¼â’½â’¾â’¿â“€â“â“‚â“ƒâ“„â“…â“†â“‡â“ˆâ“‰â“Šâ“‹â“Œâ“â“â“â“â“‘â“’â““â“”â“•â“–â“—â“˜â“™â“šâ“›â“œâ“â“â“Ÿâ“ â“¡â“¢â“£â“¤â“¥â“¦â“§â“¨â“©â’œâ’â’â’Ÿâ’ â’¡â’¢â’£â’¤â’¥â’¦â’§â’¨â’©â’ªâ’«â’¬â’­â’®â’¯â’°â’±â’²â’³â’´â’µ
ï¹¢ï¹£Ã—Ã·Â±+-*/^=â‰Œâˆ½â‰¦â‰§â‰’ï¹¤ï¹¥â‰ˆâ‰¡â‰ â‰¤â‰¥â‰®â‰¯âˆ·âˆ¶âˆâˆâˆ§âˆ¨âˆ‘âˆâˆªâˆ©âˆˆâˆµâˆ´âŠ¥âˆ¥âˆ âŒ’âŠ™âˆšâˆ›âˆœâˆŸâŠ¿ã’ã‘%â€°â…ŸÂ½â…“â…•â…™â…â…›â…‘â…’â…”Â¾â…–â…—â…˜â…šâ…œâ…â…â‰‚â‰ƒâ‰„â‰…â‰†â‰‡â‰‰â‰Šâ‰‹â‰â‰â‰â‰â‰‘â‰“â‰”â‰•â‰–â‰—â‰˜â‰™â‰šâ‰›â‰œâ‰â‰â‰Ÿâ‰¢â‰£â‰¨â‰©âŠ°âŠ±â‹›â‹šâˆ«âˆ®âˆ¬âˆ­âˆ¯âˆ°âˆ±âˆ²âˆ³â„…Ã¸Ï€âˆ€âˆâˆ‚âˆƒâˆ„âˆ…âˆ†âˆ‡âˆ‰âˆŠâˆ‹âˆŒâˆâˆâˆâˆ’âˆ“âˆ”âˆ•âˆ–âˆ—âˆ˜âˆ™âˆ¡âˆ¢âˆ£âˆ¤âˆ¦âˆ¸âˆ¹âˆºâˆ»âˆ¼âˆ¾âˆ¿â‰€â‰â‰ªâ‰«â‰¬â‰­â‰°â‰±â‰²â‰³â‰´â‰µâ‰¶â‰·â‰¸â‰¹â‰ºâ‰»â‰¼â‰½â‰¾â‰¿âŠ€âŠâŠ‚âŠƒâŠ„âŠ…âŠ†âŠ‡âŠˆâŠ‰âŠŠâŠ‹âŠŒâŠâŠâŠâŠâŠ‘âŠ’âŠ“âŠ”âŠ•âŠ–âŠ—âŠ˜âŠšâŠ›âŠœâŠâŠâŠŸâŠ âŠ¡âŠ¢âŠ£âŠ¤âŠ¦âŠ§âŠ¨âŠ©âŠªâŠ«âŠ¬âŠ­âŠ®âŠ¯âŠ²âŠ³âŠ´âŠµâŠ¶âŠ·âŠ¸âŠ¹âŠºâŠ»âŠ¼âŠ½âŠ¾â‹€â‹â‹‚â‹ƒâ‹„â‹…â‹†â‹‡â‹ˆâ‹‰â‹Šâ‹‹â‹Œâ‹â‹â‹â‹â‹‘â‹’â‹“â‹”â‹•â‹–â‹—â‹˜â‹™â‹œâ‹â‹â‹Ÿâ‹ â‹¡â‹¢â‹£â‹¤â‹¥â‹¦â‹§â‹¨â‹©â‹ªâ‹«â‹¬â‹­â‹®â‹¯â‹°â‹±â‹²â‹³â‹´â‹µâ‹¶â‹·â‹¸â‹¹â‹ºâ‹»â‹¼â‹½â‹¾â‹¿â… â…¡â…¢â…£â…¤â…¥â…¦â…§â…¨â…©â…ªâ…«â…¬â…­â…®â…¯â†â†‚â†ƒâ†…â††â†‡â†ˆâ†‰â†Šâ†‹â– â–¡â–¢â–£â–¤â–¥â–¦â–§â–¨â–©â–ªâ–«â–¬â–­â–®â–¯â–°â–±â–²â–³â–´â–µâ–¶â–·â–¸â–¹â–ºâ–»â–¼â–½â–¾â–¿â—€â—â—‚â—ƒâ—„â—…â—†â—‡â—ˆâ—‰â—Šâ—‹â—Œâ—â—â—â—â—‘â—’â—“â—”â—•â—–â——â—˜â—™â—šâ—›â—œâ—â—â—Ÿâ— â—¡â—¢â—£â—¤â—¥â—¦â—§â—¨â—©â—ªâ—«â—¬â—­â—®â—¯â—°â—±â—²â—³â—´â—µâ—¶â—·â—¸â—¹â—ºâ—¿â—»â—¼â—½â—¾â¢â¥âŒ“âŒ”âŒ–
â° Â¹ Â² Â³ â´ âµ â¶ â· â¸ â¹ âº â» â¼ â½ â¾ â¿ â‚€ â‚ â‚‚ â‚ƒ â‚„ â‚… â‚† â‚‡ â‚ˆ â‚‰ â‚Š â‚‹ â‚Œ â‚ â‚ â‚ â‚‘ â‚’ â‚“ â‚” â‚• â‚– â‚— â‚˜ â‚™ â‚š â‚› â‚œ
â™¥â£áƒ¦â™ â™¡â™¤â¤â¥
ã€‚ï¼Œã€ï¼‡ï¼šâˆ¶ï¼›?â€˜â€™â€œâ€ã€ã€Ë†Ë‡ï¹•ï¸°ï¹”ï¹–ï¹‘â€¢Â¨â€¦.Â¸;ï¼Â´ï¼Ÿï¼ï½â€”Ë‰ï½œâ€–ï¼‚ã€ƒï½€@ï¹«Â¡Â¿ï¹ï¹‹ï¹Œï¸´ã€…ï¹Ÿ#ï¹©$ï¹ &ï¹ª%*ï¹¡ï¹¢ï¹¦ï¹¤â€ï¿£Â¯â€•ï¹¨Ë†Ëœï¹ï¹+=<ï¼¿_-\Ë‡~ï¹‰ï¹Šï¼ˆï¼‰ã€ˆã€‰â€¹â€ºï¹›ï¹œã€ã€ã€–ã€—ï¼»ï¼½ã€Šã€‹ã€”ã€•{}ã€Œã€ã€ã€‘ï¸µï¸·ï¸¿ï¸¹ï¸½_ï¹ï¹ƒï¸»ï¸¶ï¸¸ï¹€ï¸ºï¸¾Ë‰ï¹‚ï¹„ï¸¼âââ€â€‘â€’â€“â€•â€–â€—â€˜â€™â€šâ€›â€œâ€â€â€Ÿâ€ â€¡â€¢â€£â€¤â€¥â€¦â€§â€°â€±â€²â€³â€´â€µâ€¶â€·â€¸â€»â€¼â€½â€¾â€¿â€ââ‚âƒâ„â‡âˆâ‰âŠâ‹âŒâââââ‘â’â“â”â•â–â—â˜â™âšâ›âœââ
Â°â€²â€³ï¼„ï¿¥ã€’ï¿ ï¿¡ï¼…ï¼ â„ƒâ„‰ï¹©ï¹ªâ€°ï¹«ã¡ã¥mÂ²mÂ³ãœãŸã£ãã ã¤ã·ã¸ã¹ãã¢ã¦ããšã›ã•ãããã„Âºâ—‹Â¤%$ÂºÂ¹Â²Â³ãºã€ãã‚ãƒã„ã…ã†ã‡ãˆã‰ãŠã‹ãŒãã‘ã’ã“ã”ã•ã–ã—ã˜ã™ã§ã¨ã©ãªã«ã¬ã­ã®ã¯ã°ã±ã²ã³ã´ãµã¶ã·ã¸ã¹ãºã»ã¼ã½ã¾ã¿ã€ãã‚ãƒã„ã…ã†ã‡ãˆã‰ãŠã‹ãŒããããã‘ã’ã“ã”ã•ã–ã—ã˜ã™ãšã›ãœãããŸã±ã²ã³ã´ãµã¶
â†‘â†“â†â†’â†–â†—â†˜â†™â†”â†•â»â¼â½â¸â³âºâ»â´âµâ¶â·â¹â–¶â–ºâ–·â—â—€â—„Â«Â»â©âªâ«â¬â­â®â¯â±ââ²â¾â”â˜â™âšâ›âœâââŸâ â¡â¢â£â¤â¥â¦â§â¨â†šâ†›â†œâ†â†â†Ÿâ† â† â†¡â†¢â†£â†¤â†¤â†¥â†¦â†§â†¨â‡„â‡…â‡†â‡‡â‡ˆâ‡‰â‡Šâ‡‹â‡Œâ‡â‡â‡â‡â‡‘â‡’â‡“â‡”â‡–â‡—â‡˜â‡™â‡œâ†©â†ªâ†«â†¬â†­â†®â†¯â†°â†±â†²â†³â†´â†µâ†¶â†·â†¸â†¹â˜‡â˜ˆâ†¼â†½â†¾â†¿â‡€â‡â‡‚â‡ƒâ‡â‡Ÿâ‡ â‡¡â‡¢â‡£â‡¤â‡¥â‡¦â‡§â‡¨â‡©â‡ªâ†ºâ†»â‡šâ‡›
â‚¬Â£Ò°â‚´$â‚°Â¢â‚¤Â¥â‚³â‚²â‚ªâ‚µå…ƒâ‚£â‚±à¸¿Â¤â‚¡â‚®â‚­â‚©Şƒå††â‚¢â‚¥â‚«â‚¦zÅ‚ï·¼â‚ â‚§â‚¯â‚¨KÄà¤°â‚¹Æ’â‚¸ï¿ 
ÄÃ¡ÇÃ ÅÃ³Ç’Ã²Ä“Ã©Ä›Ã¨Ä«Ã­ÇÃ¬Å«ÃºÇ”Ã¹Ç–Ç˜ÇšÇœÃ¼ÃªÉ‘îŸ‡Å„ÅˆîŸˆÉ¡ã„…ã„†ã„‡ã„ˆã„‰ã„Šã„‹ã„Œã„ã„ã„ã„ã„‘ã„’ã„“ã„”ã„•ã„–ã„—ã„˜ã„™ã„šã„›ã„œã„ã„ã„Ÿã„ ã„¡ã„¢ã„£ã„¤ã„¥ã„¦ã„§ã„¨ã„©
ãã‚ãƒã„ã…ã†ã‡ãˆã‰ãŠã‹ãŒããããã‘ã’ã“ã”ã•ã–ã—ã˜ã™ãšã›ãœãããŸã ã¡ã¢ã£ã¤ã¥ã¦ã§ã¨ã©ãªã«ã¬ã­ã®ã¯ã°ã±ã²ã³ã´ãµã¶ã·ã¸ã¹ãºã»ã¼ã½ã¾ã¿ã‚€ã‚ã‚‚ã‚ƒã‚„ã‚…ã‚†ã‚‡ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚ã‚ã‚‘ã‚’ã‚“ã‚”ã‚•ã‚–ã‚¡ã‚¢ã‚£ã‚¤ã‚¥ã‚¦ã‚§ã‚¨ã‚©ã‚ªã‚«ã‚¬ã‚­ã‚®ã‚¯ã‚°ã‚±ã‚²ã‚³ã‚´ã‚µã‚¶ã‚·ã‚¸ã‚¹ã‚ºã‚»ã‚¼ã‚½ã‚¾ã‚¿ãƒ€ãƒãƒ‚ãƒƒãƒ„ãƒ…ãƒ†ãƒ‡ãƒˆãƒ‰ãƒŠãƒ‹ãƒŒãƒãƒãƒãƒãƒ‘ãƒ’ãƒ“ãƒ”ãƒ•ãƒ–ãƒ—ãƒ˜ãƒ™ãƒšãƒ›ãƒœãƒãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ£ãƒ¤ãƒ¥ãƒ¦ãƒ§ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ®ãƒ¯ãƒ°ãƒ±ãƒ²ãƒ³ãƒ´ãƒµãƒ¶ãƒ·ãƒ¸ãƒ¹ãƒºãƒ»ãƒ¼ãƒ½ãƒ¾ãƒ¿ã‚ ã‡°ã‡±ã‡²ã‡³ã‡´ã‡µã‡¶ã‡·ã‡¸ã‡¹ã‡ºã‡»ã‡¼ã‡½ã‡¾ã‡¿
é›¶å£¹è´°åè‚†ä¼é™†æŸ’æŒç–æ‹¾ä½°ä»Ÿä¸‡äº¿å‰å¤ªæ‹è‰¾åˆ†å˜æ¯«å¾®ååå„å·œå¼å¼å¼æœ¤æ°ºæ›±ç”´å›å…€ã€…ã€†ã®ãã€¡ã€¢ã€£ã€¤ã€¥ã€¦ã€§ã€¨ã€©ãŠãŠãŠŒãŠ‹ãŠãŠšãŠ›ãŠãŠŠãŠ£ãŠ¤ãŠ¥ãŠ¦ãŠ§ãŠ¨ãŠ’ãŠ«ãŠ‘ãŠ“ãŠ”ãŠ•ãŠ–ãŠ—ãŠ˜ãŠœãŠãŠãŠŸãŠ ãŠ¡ãŠ¢ãŠ©ãŠªãŠ¬ãŠ­ãŠ®ãŠ¯ãŠ°ãŠ€ãŠãŠ‚ãŠƒãŠ„ãŠ…ãŠ†ãŠ‡ãŠˆãŠ‰
â”€ â”â”‚â”ƒâ•Œâ•â•â•â”„ â”…â”†â”‡â”ˆ â”‰â”Šâ”‹â”Œâ”â”â”â”â”‘â”’â”“â”” â”•â”–â”— â”˜â”™â”šâ”›â”œâ”â”â”Ÿâ” â”¡â”¢â”£ â”¤â”¥â”¦â”§â”¨â”©â”ªâ”«â”¬ â”­ â”® â”¯ â”° â”± â”² â”³ â”´ â”µ â”¶ â”· â”¸ â”¹ â”º â”»â”¼ â”½ â”¾ â”¿ â•€ â• â•‚ â•ƒ â•„ â•… â•† â•‡ â•ˆ â•‰ â•Š â•‹ â•ª â•« â•¬â•â•‘â•’â•“â•” â••â•–â•—â•˜â•™â•š â•›â•œâ•â•â•Ÿâ•  â•¡â•¢â•£â•¤ â•¥ â•¦ â•§ â•¨ â•© â•³â•” â•—â•â•š â•¬ â• â•“ â•© â”  â”¨â”¯ â”·â” â”“â”— â”›â”³ âŠ¥ ï¹ƒ ï¹„â”Œ â•® â•­ â•¯â•°
â™šâ™›â™â™â™œâ™Ÿâ™”â™•â™—â™˜â™–â™Ÿ
Î‘Î’Î“Î”Î•Î–Î—Î˜Î™ÎšÎ›ÎœÎÎÎŸÎ Î¡Î£Î¤Î¥Î¦Î§Î¨Î©Î±Î²Î³Î´ÎµÎ¶Î½Î¾Î¿Ï€ÏÏƒÎ·Î¸Î¹ÎºÎ»Î¼Ï„Ï…Ï†Ï‡ÏˆÏ‰
ĞĞ‘Ğ’Ğ“Ğ”Ğ•ĞĞ–Ğ—Ğ˜Ğ™ĞšĞ›ĞœĞĞĞŸĞ Ğ¡Ğ¢Ğ£Ğ¤Ğ¥Ğ¦Ğ§Ğ¨Ğ©ĞªĞ«Ğ¬Ğ­Ğ®Ğ¯Ğ°Ğ±Ğ²Ğ³Ğ´ĞµÑ‘Ğ¶Ğ·Ğ¸Ğ¹ĞºĞ»Ğ¼Ğ½Ğ¾Ğ¿Ñ€ÑÑ‚ÑƒÑ„Ñ…Ñ†Ñ‡ÑˆÑ‰ÑŠÑ‹ÑŒÑÑÑ
ã€‡
""".strip().replace("\n", "")
    final_chars.update(list(special_chars))

    # 3'. æ·»åŠ å…¨è§’å­—ç¬¦ (é˜²æ­¢é—æ¼)
    fullwidth_chars = set(chr(i) for i in range(0xFF01, 0xFF5E + 1))
    final_chars.update(fullwidth_chars)

    # 4. æå–å¸¸ç”¨å­—
    regular_chars = final_chars.copy()
    common_chars = get_combined_chars()
    if common_chars:
        regular_chars.update(common_chars)
        print(f"   å·²åˆå¹¶å¸¸ç”¨å­—ï¼Œå½“å‰æ€»æ•°: {len(regular_chars)}")

    # 5. ç”Ÿæˆä¸´æ—¶å­—ç¬¦é›†æ–‡ä»¶
    subset_text = "".join(sorted(final_chars))
    text_file = 'subset_temp.txt'
    with open(text_file, 'w', encoding='utf-8') as f:
        f.write(subset_text)

    regular_subset_text = "".join(sorted(regular_chars))
    regular_text_file = 'subset_regular_temp.txt'
    with open(regular_text_file, 'w', encoding='utf-8') as f:
        f.write(regular_subset_text)
    
    print(f"\nğŸ“ æœ€ç»ˆå­—ç¬¦é›†å‡†å¤‡å®Œæ¯•ï¼Œå…±åŒ…å« {len(regular_subset_text)} ä¸ªå­—ç¬¦ã€‚")
    print("ğŸš€ å¼€å§‹æ‰¹é‡ç”Ÿæˆå­—ä½“ (è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)...\n")

    generated_results = []

    # 6. å¾ªç¯å¤„ç†æ¯ä¸ªå­—é‡
    for source_path, weight in FONTS_CONFIG.items():
        file_base_name = os.path.splitext(os.path.basename(source_path))[0]
        output_filename = f"{file_base_name}-Subset.ttf" # æ¢ä¸ªåç¼€ä»¥ç¤ºåŒºåˆ†
        output_path = os.path.join(FONT_DIR, output_filename)

        if not os.path.exists(source_path):
            print(f"âš ï¸ è·³è¿‡: æ‰¾ä¸åˆ°æºæ–‡ä»¶ {source_path}")
            continue

        print(f"â³ æ­£åœ¨å¤„ç†: {source_path} (Weight: {weight})...")

        command = [
            'pyftsubset',
            source_path,
            f'--text-file={regular_text_file if weight == 400 or weight == 700 else text_file}',
            f'--output-file={output_path}',
            '--layout-features=*',
            '--name-IDs=*',
            '--name-legacy',
            '--no-hinting',
            '--desubroutinize'
        ]

        try:
            subprocess.run(command, check=True)
            
            old_size = os.path.getsize(source_path) / 1024 / 1024
            new_size = os.path.getsize(output_path) / 1024 / 1024 # ç”¨ MB æ˜¾ç¤ºæ¯”è¾ƒç›´è§‚
            
            print(f"   âœ… æˆåŠŸ! {old_size:.2f} MB -> {new_size:.2f} MB")
            
            generated_results.append({
                "asset": f"assets/fonts/{output_filename}",
                "weight": weight
            })
            
        except subprocess.CalledProcessError as e:
            print(f"   âŒ å¤„ç†å¤±è´¥: {e}")

    # 7. æ¸…ç†
    if os.path.exists(text_file):
        os.remove(text_file)

    if os.path.exists(regular_text_file):
        os.remove(regular_text_file)

    # 8. ç”Ÿæˆ Pubspec é…ç½®
    generated_results.sort(key=lambda x: x['weight'])
    print("\n" + "="*50)

    print("ğŸ‰ å…¨éƒ¨å®Œæˆï¼è¯·æ›´æ–°ä½ çš„ pubspec.yaml:")
    print("="*50)
    print(f"  fonts:")
    print(f"    - family: {FONT_FAMILY_NAME}")
    print(f"      fonts:")
    for item in generated_results:
        if (item['weight'] == 400):
            continue
        print(f"        - asset: {item['asset']}")
        print(f"          weight: {item['weight']}")

    print(f"    - family: {FONT_FAMILY_CONTENT_NAME}")
    print(f"      fonts:")
    for item in generated_results:
        if (item['weight'] != 400 and item['weight'] != 700):
            continue
        print(f"        - asset: {item['asset']}")
        print(f"          weight: {item['weight']}")

    print("="*50)

if __name__ == '__main__':
    main()